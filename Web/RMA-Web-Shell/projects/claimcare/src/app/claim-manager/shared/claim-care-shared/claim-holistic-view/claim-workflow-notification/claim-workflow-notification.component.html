<div *ngIf="(isLoading$ | async)">
  <mat-card>
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <label class="mat-label other-label"><i>loading referrals...please wait</i></label>
  </mat-card>
</div>

<div class="menu-bar">
  <span class="material-icons">insert_comment</span>
  Referrals
  <span *ngIf="!(showForm$ | async)" (click)="showForm(null)" class="material-icons pointer right pulse" matTooltip="add referral">
    add_circle
  </span>
</div>

<div *ngIf="(showForm$ | async) && !(isLoading$ | async)">
  <mat-card>
    <div *ngIf="!(isLoading$ | async)" class="menu-bar">
      <span *ngIf="!(isLoading$ | async)" (click)="cancel()" class="material-icons pointer right"
          matTooltip="close">
          close
      </span>
      <span *ngIf="form.valid && !form.pristine" (click)="save()"
          class="material-icons pointer right pulseGreen" matTooltip="save">
          save
      </span>
    </div>

    <div [hidden]="(isLoading$ | async)">
      <form [formGroup]="form" class="mat-container details-form" novalidate>
        <section>
          <mat-form-field class="mat-form-field">
            <label class="mat-label other-label mandatory-field">Date Created</label>
            <input matInput formControlName="dateCreated" [matDatepicker]="dateCreated" id="dateCreated" name="dateCreated"
              [max]="maxDate">
            <mat-datepicker-toggle matSuffix [for]="dateCreated" [disabled]="false"></mat-datepicker-toggle>
            <mat-datepicker startView="month" touchUi="true" #dateCreated></mat-datepicker>
          </mat-form-field>
  
          <mat-form-field class="mat-form-field-right">
            <label class="mat-label other-label mandatory-field">Generated By</label>
            <input matInput formControlName="generatedBy" name="generatedBy" id="generatedBy" />
          </mat-form-field>
        </section>

        <section>
          <mat-form-field class="mat-form-field" *ngIf="replybtnSelected">
            <label class="mat-label other-label">Department</label>
            <mat-select name="roleType" id="roleType" formControlName="roleType" 
              (selectionChange)="onDepartmentChanged($event)">
              <mat-option *ngFor="let roleType of roleTypes" [value]="roleType">
                {{formatLookup(roleType)}}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="form.get('roleType').hasError('required')">
              Department is <strong>required</strong>
            </mat-error>
          </mat-form-field>
  
          <mat-form-field class="mat-form-field-right">
            <label class="mat-label other-label">Nature of Query</label>
            <mat-select name="referralQueryType" id="referralQueryType" formControlName="referralQueryType"
              (selectionChange)="onReferralQueryTypeChanged($event)">
              <mat-option *ngFor="let referralQueryType of referralQueryTypes" [value]="referralQueryType.referralQueryTypeId">
                {{referralQueryType.name}}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="form.get('referralQueryType').hasError('required')">
              Nature of Query type is <strong>required</strong>
            </mat-error>
          </mat-form-field>
        </section>
  
        <section>
          <mat-form-field class="mat-form-field" *ngIf="replybtnSelected">
            <label class="mat-label other-label">Refer To</label>
            <mat-select id="referToUser" name="referToUser" matInput formControlName="referToUser"
              (selectionChange)="filterByUserName($event)">
              <input matInput (keyup)="onUserKeyChange($event.target.value)">
              <mat-option [value]="0">Select User</mat-option>
              <mat-option *ngFor="let user of filteredUsers" [value]="user.id">
                {{user.displayName}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </section>
  
        <section>
          <mat-form-field class="mat-form-field">
            <label class="mat-label other-label">Message</label>
            <textarea matInput maxlength="250" minlength="3" id="textMessage" name="textMessage" formControlName="textMessage"
              style="height: 120px;"></textarea>
            <mat-error *ngIf="form.get('textMessage').hasError('required')">
              Text message is <strong>required</strong>
            </mat-error>
            <mat-error *ngIf="form.get('textMessage').hasError('minlength')">
              Text message must be at least <strong>3 characters</strong>
            </mat-error>
            <mat-error *ngIf="form.get('textMessage').hasError('maxlength')">
              Text message must be at most <strong>250 characters</strong>
            </mat-error>
          </mat-form-field>
  
          <mat-form-field class="mat-form-field-right">
            <label class="mat-label other-label">Feedback to Query</label>
            <textarea matInput maxlength="250" minlength="3" id="feedbackToQueryMessage" name="feedbackToQueryMessage" formControlName="feedbackToQueryMessage"
              style="height: 120px;"></textarea>
            <mat-error *ngIf="form.get('feedbackToQueryMessage').hasError('required')">
              Feedback to Query is <strong>required</strong>
            </mat-error>
            <mat-error *ngIf="form.get('feedbackToQueryMessage').hasError('minlength')">
              Feedback to Query must be at least <strong>3 characters</strong>
            </mat-error>
            <mat-error *ngIf="form.get('feedbackToQueryMessage').hasError('maxlength')">
              Feedback to Query must be at most <strong>250 characters</strong>
            </mat-error>
          </mat-form-field>
        </section>
    
        <section>
          <mat-form-field class="mat-form-field">
            <label class="mat-label other-label mandatory-field">Feeback Date</label>
            <input matInput formControlName="feedbackDate" [matDatepicker]="feedbackDate" id="feedbackDate" name="feedbackDate"
              [max]="maxDate">
            <mat-datepicker-toggle matSuffix [for]="feedbackDate" [disabled]="false"></mat-datepicker-toggle>
            <mat-datepicker startView="month" touchUi="true" #feedbackDate></mat-datepicker>
          </mat-form-field>
        </section>
  
        <section>
          <mat-form-field class="mat-form-field">
            <label class="mat-label other-label">Rate Feedback</label>
            <mat-select name="rateFeedback" id="rateFeedback"
              formControlName="rateFeedback">
            </mat-select>
            <mat-error *ngIf="form.get('rateFeedback').hasError('required')">
              Rate Feedback is <strong>required</strong>
            </mat-error>
          </mat-form-field>
  
          <mat-form-field class="mat-form-field-right">
            <label class="mat-label other-label">Resolution Status</label>
            <input matInput formControlName="resolutionStatus" />
          </mat-form-field>
        </section>
        
        <section *ngIf="suspiciousTransaction">
          <mat-form-field class="mat-form-field">
            <div class="field-container check-box" *ngIf="!isScaTeamLead">
              <label class="mat-label other-label">&nbsp;</label>
              <input [hidden]="true" matInput formControlName="ckBoxSuspicious" />
              <mat-checkbox (click)="checkSuspicious(checked)" formControlName="ckBoxSuspicious">
                <label class="mat-label other-label">Suspicious</label>
              </mat-checkbox>
            </div>
            <div class="field-container check-box" *ngIf="isScaTeamLead">
              <label class="mat-label other-label">&nbsp;</label>
              <input [hidden]="true" matInput formControlName="ckBoxInvestigation" />
              <mat-checkbox (click)="checkSuspicious(checked)" formControlName="ckBoxInvestigation">
                <label class="mat-label other-label">Investigation referral</label>
              </mat-checkbox>
            </div>
          </mat-form-field>
        </section>
  
      </form>
    </div>
  </mat-card>
</div>

<div>
  <div [hidden]="!(dataSource && dataSource && dataSource.length > 0)">
    <mat-table #table [dataSource]="dataSource" matSort id="tblData">
      <ng-container matColumnDef="dateCreated">
        <mat-header-cell *matHeaderCellDef> Date Created </mat-header-cell>
        <mat-cell *matCellDef="let row">{{row.receivedDate}}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="generatedBy">
        <mat-header-cell *matHeaderCellDef> Generated By </mat-header-cell>
        <mat-cell *matCellDef="let row">{{row.createdBy}}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="message">
        <mat-header-cell *matHeaderCellDef> Message </mat-header-cell>
        <mat-cell *matCellDef="let row">{{row.referralQuery}}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="referalQueryStage">
        <mat-header-cell *matHeaderCellDef> Query Stage</mat-header-cell>
        <mat-cell *matCellDef="let row">{{getQueryType(row.referralStatusId)}}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="userReferredTo">
        <mat-header-cell *matHeaderCellDef> User Referred To </mat-header-cell>
        <mat-cell *matCellDef="let row">{{row.referredToUserName}}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef>
          <span class="material-icons noHover">
            more_vert
          </span>
        </mat-header-cell>
        <mat-cell *matCellDef="let row" [matMenuTriggerFor]="menu" (click)="filterMenu(row)">
          <span class="material-icons pointer right">
            more_vert
          </span>
          <mat-menu #menu="matMenu">
            <button mat-menu-item *ngFor="let menu of menus" [value]="menu" (click)="onMenuSelect(row, menu)"
              disabled={{menu.disable}}>{{menu.title}}</button>
          </mat-menu>
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
    </mat-table>
  </div>

  <div *ngIf="!(dataSource && dataSource && dataSource.length > 0 || (isLoading$ | async))">
      <mat-card>
          <label class="mat-label other-label"><i>No referrals found...</i></label>
      </mat-card>
  </div>
</div>